import{u as ee}from"./chunk-HFB3OQXI-C3o_K4vd.js";import{C as se}from"./chunk-OFN7DIZA-h63_2j5d.js";import{r as D,j as e,b as O,K as ae,e9 as te,Z as le,Q as P,ea as re,H as ie,_ as de,X as d,au as m,J as ne,a2 as ce,aj as ue,B as Z,v as oe,s as xe,Y as G}from"./index-bzW-SAbR.js";var L=l=>(l||[]).map(s=>{var u,b;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(u=s.values[0])==null?void 0:u.value:s.values:(b=s==null?void 0:s.values)==null?void 0:b.map(g=>g.value)}}),be=(l,s)=>{var u;return!l||!s?{}:l==="currency_code"?{value:(u=s.supported_currencies)==null?void 0:u.map(b=>b.currency_code)}:{}},ge=({form:l,identifier:s,scope:u,name:b,operator:g,fieldRule:a,attributes:y,ruleType:$,applicationMethodTargetType:j})=>{const{t:q}=O(),r=y==null?void 0:y.find(x=>x.value===a.attribute),{store:v,isLoading:n}=oe(),S=ee({queryFn:async x=>await xe.admin.promotion.listRuleValues($,r==null?void 0:r.id,{...x,...be(r==null?void 0:r.id,v),application_method_target_type:j}),enabled:!!(r!=null&&r.id)&&["select","multiselect"].includes(r.field_type)&&!n,getOptions:x=>x.values,queryKey:["rule-value-options",$,r==null?void 0:r.id]}),_=P({control:l.control,name:g});return D.useEffect(()=>{Object.keys(l.formState.dirtyFields).length>0&&(_==="eq"?l.setValue(b,""):l.setValue(b,[]))},[_]),e.jsx(d.Field,{name:b,render:({field:{onChange:x,ref:f,...p}})=>(r==null?void 0:r.field_type)==="number"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(G,{...p,type:"number",onChange:x,className:"bg-ui-bg-base",ref:f,min:1,disabled:!a.attribute})}),e.jsx(d.ErrorMessage,{})]}):(r==null?void 0:r.field_type)==="text"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(G,{...p,ref:f,onChange:x,className:"bg-ui-bg-base",disabled:!a.attribute})}),e.jsx(d.ErrorMessage,{})]}):e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(se,{...p,...S,ref:f,placeholder:q(_==="eq"?"labels.selectValue":"labels.selectValues"),disabled:!_,onChange:x})}),e.jsx(d.ErrorMessage,{})]})},`${s}.${u}.${b}-${a.attribute}`)},U={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},je=({form:l,ruleType:s,setRulesToRemove:u,rulesToRemove:b,scope:g="rules",promotion:a,formType:y="create"})=>{var J,Q,W;const $=D.useRef(!1),{t:j}=O(),q=ae(),r=l.getValues(),{attributes:v}=te(s,r.type,(J=r.application_method)==null?void 0:J.target_type),{fields:n,append:S,remove:_,update:x,replace:f}=le({control:l.control,name:g,keyName:g}),p=P({control:l.control,name:"type",defaultValue:a==null?void 0:a.type}),K=P({control:l.control,name:"application_method.type",defaultValue:(Q=a==null?void 0:a.application_method)==null?void 0:Q.type}),I=P({control:l.control,name:"application_method.target_type",defaultValue:(W=a==null?void 0:a.application_method)==null?void 0:W.target_type}),T=p?{promotion_type:p,application_method_type:K,application_method_target_type:I}:{},{rules:N,isLoading:X}=re((a==null?void 0:a.id)||null,s,T,{enabled:!!(a!=null&&a.id)||!!p&&!!K});return D.useEffect(()=>{if(!X&&!(!n.length&&y==="edit"&&$.current)){if(s==="rules"&&!n.length&&(l.resetField("rules"),f(L(N))),s==="buy-rules"&&!n.length){l.resetField("application_method.buy_rules");const i=a!=null&&a.id||p==="standard"?N:[...N,U];f(L(i))}if(s==="target-rules"&&!n.length){l.resetField("application_method.target_rules");const i=a!=null&&a.id||p==="standard"?N:[...N,U];f(L(i))}$.current=!0}},[p,X,s,n.length,y,l,f,N,a==null?void 0:a.id]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(ie,{level:"h2",className:"mb-2",children:j(s==="target-rules"?`promotions.fields.conditions.${s}.${I}.title`:`promotions.fields.conditions.${s}.title`)}),e.jsx(de,{className:"text-ui-fg-subtle txt-small mb-6",children:j(s==="target-rules"?`promotions.fields.conditions.${s}.${I}.description`:`promotions.fields.conditions.${s}.description`)}),n.map((i,o)=>{const F=i.id;return e.jsxs(D.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(d.Field,{name:`${g}.${o}.attribute`,render:({field:C})=>{var k;const{onChange:z,ref:A,...M}=C,V=(n==null?void 0:n.map(t=>t.attribute))||[],c=(v==null?void 0:v.filter(t=>t.value===i.attribute?!0:!V.includes(t.value)))||[],B=!!i.required,w=t=>{var Y;const h=c.find(R=>R.id===t),E={...i,disguised:(h==null?void 0:h.disguised)||!1};((Y=h==null?void 0:h.operators)==null?void 0:Y.length)===1&&(E.operator=h.operators[0].value),E.operator==="eq"?E.values="":E.values=[],x(o,E),z(t)};return e.jsxs(d.Item,{className:"mb-2",children:[i.required&&e.jsx("div",{className:"flex items-center px-2",children:e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:j("promotions.form.required")})}),e.jsx(d.Control,{children:B?e.jsx(H,{label:((k=c==null?void 0:c.find(t=>t.value===i.attribute))==null?void 0:k.label)||"",field:C}):e.jsxs(m,{dir:q,...M,onValueChange:w,disabled:i.required,children:[e.jsx(m.Trigger,{ref:A,className:"bg-ui-bg-base",children:e.jsx(m.Value,{placeholder:j("promotions.form.selectAttribute")})}),e.jsx(m.Content,{children:c==null?void 0:c.map((t,h)=>e.jsx(m.Item,{value:t.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:t.label})},`${F}-attribute-option-${h}`))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d.Field,{name:`${g}.${o}.operator`,render:({field:C})=>{var w,k;const{onChange:z,ref:A,...M}=C,V=v==null?void 0:v.find(t=>t.value===i.attribute),c=((w=V==null?void 0:V.operators)==null?void 0:w.map((t,h)=>({label:t.label,value:t.value,key:`${F}-operator-option-${h}`})))||[],B=!!i.attribute&&(c==null?void 0:c.length)<=1;return e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:B?e.jsx(H,{label:((k=c.find(t=>t.value===M.value))==null?void 0:k.label)||"",field:C}):e.jsxs(m,{dir:q,...M,disabled:!i.attribute,onValueChange:z,children:[e.jsx(m.Trigger,{ref:A,className:"bg-ui-bg-base",children:e.jsx(m.Value,{placeholder:"Select Operator"})}),e.jsx(m.Content,{children:c==null?void 0:c.map(t=>e.jsx(m.Item,{value:t.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:t.label})},t.key))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsx(ge,{form:l,identifier:F,scope:g,name:`${g}.${o}.values`,operator:`${g}.${o}.operator`,fieldRule:i,attributes:v,ruleType:s,applicationMethodTargetType:I})]})]}),e.jsx("div",{className:"size-7 flex-none self-center",children:!i.required&&e.jsx(ne,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:()=>{i.required||(u&&u([...b,i]),_(o))},children:e.jsx(ce,{})})})]}),o<n.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(ue,{size:"2xsmall",className:" text-xs",children:j("promotions.form.and")})]})]},`${i.id}.${o}.${i.attribute}`)}),e.jsxs("div",{className:n.length?"mt-6":"",children:[e.jsx(Z,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{S({attribute:"",operator:"",values:[],required:!1})},children:j("promotions.fields.addCondition")}),!!n.length&&e.jsx(Z,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const i=n.map((o,F)=>o.required?null:F).filter(o=>o!==null);u&&u(n.filter(o=>!o.required)),_(i)},children:j("promotions.fields.clearAll")})]})]})},H=D.forwardRef(({label:l,field:s},u)=>e.jsxs("div",{children:[e.jsx("div",{className:"txt-compact-small bg-ui-bg-component shadow-borders-base text-ui-fg-base h-8 rounded-md px-2 py-1.5",children:l}),e.jsx("input",{...s,ref:u,disabled:!0,hidden:!0})]}));H.displayName="DisabledField";export{je as R};
